# XDG Desktop Portal

[XDG Desktop Portals](https://flatpak.github.io/xdg-desktop-portal/docs/) are a set of [DBus interfaces](dbus.md) that provide functionality expected to be useful for Flatpak/sandboxed applications in a desktop environment. For example opening a desktop environment specific file chooser dialog.

The main difference from vanilla DBus is that the portals have a more fine grained authorisation system. I think this is implemented by having a separate DBus socket to the regular user session which is made available to the sandboxed app. The app can make calls to this separate socket which are then routed to the regular session bus via a 'frontend'. The 'frontend' knows which Flatpak app made the call and can decide whether to give it access to the particular API. On the regular DBus session bus one or more 'backends' implement a corresponding API that actually covers the functionality. The 'frontend' API also appears to be available on the regular user session bus (just presumably without authorisation here).

Under Wayland the 'backends' seem to be closely tied to the [compositor](wayland-compositors.md) they run under. So there'll be a process implementing some APIs for GNOME, and a different one for WLroots based compositors. It looks like the backends don't have to implement all the DBus interfaces, they can delegate some to other 'backends'. For example the WLroots backend only implements screencast/screenshot interfaces as of writing. I think it delegates e.g. the Notification method to the GTK backend if that's available. I haven't researched how this sharing of functionality works.

So I think it all goes together like this. We might have a Flatpak app that calls the `org.freedesktop.portal.Notification.AddNotification` method on the `org.freedesktop.portal.Notification` well known name by writing to its private DBus unix socket. This will get sent to the 'frontend' process outside the sandbox which will decide whether to authorise it. The 'frontend' will then send a DBus message to the `org.freedesktop.impl.portal.desktop.gtk` well known name on the regular user session bus. The `xdg-desktop-portal-gtk` process will receive that method call and probably send a regular `org.freedesktop.Notifications.Notify` DBus message back to the session bus. Whatever is implementing that will receive the message and display the notification.

## Portal 'backends'

There are a [list of backends](https://github.com/flatpak/xdg-desktop-portal#using-portals) for this system. In summary it looks like there's one per family of [Wayland compositor](wayland-compositors.md) plus one for each of the major GUI toolkits (Qt, GTK). I imagine toolkit specific things like the file chooser dialog go in the GUI toolkit one, and things like screensharing that require the compositor go in the compositor one.
